name: Create Release and Get PRs

on:
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  releases: write

jobs:
  create_release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Get the latest release tag
        id: get_latest_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          latest_tag=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r .tag_name)
          echo "tag=$latest_tag" >> $GITHUB_ENV
          echo "Latest tag: $latest_tag"

      - name: Get pull requests since last release
        id: get_prs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          latest_release=${{ env.tag }}
          echo "Latest release: $latest_release"
          prs=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls?state=closed&sort=updated&direction=desc" | \
            jq -r --arg latest_release "$latest_release" '[.[] | select(.merged_at != null and .merged_at > $latest_release)] | .[] | "- PR #\(.number): \(.title) (\(.html_url))"')
          echo "prs=$prs" >> $GITHUB_ENV
          echo "Pull Requests: $prs"

      - name: Print pull requests
        run: |
          echo "Pull Requests since last release:"
          echo "${{ env.prs }}" 

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## Pull Requests since last release
            ${{ env.prs }}
          draft: false
          prerelease: false
