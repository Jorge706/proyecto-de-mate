name: Create Release and Get PRs

on:
  workflow_dispatch:

jobs:
  create_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      # 🔍 Obtener el último tag (release)
      - name: Get the latest release tag
        id: get_latest_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          latest_tag=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" | jq -r .tag_name)

          if [[ "$latest_tag" == "null" ]]; then
            latest_tag="v0.0.0"
          fi

          echo "latest_tag=$latest_tag" >> $GITHUB_ENV

      # 🔢 Generar nuevo tag automáticamente (incrementar versión)
      - name: Generate new version tag
        id: generate_tag
        run: |
          IFS='.' read -ra VERSION <<< "${{ env.latest_tag }}"
          new_tag="v${VERSION[0]}.$((VERSION[1] + 1)).0"
          echo "new_tag=$new_tag" >> $GITHUB_ENV

      # 🔍 Obtener el compare entre la última versión y la nueva
      - name: Get commit and PR changes
        id: get_changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          compare_url="https://api.github.com/repos/${{ github.repository }}/compare/${{ env.latest_tag }}...main"
          compare_data=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "$compare_url")

          pr_list=$(echo "$compare_data" | jq -r '.commits[] | select(.commit.message | test("#[0-9]+")) | "- \(.commit.message)"')
          commit_list=$(echo "$compare_data" | jq -r '.commits[] | "- \(.commit.message)"')

          echo "pr_list<<EOF" >> $GITHUB_ENV
          echo "$pr_list" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "commit_list<<EOF" >> $GITHUB_ENV
          echo "$commit_list" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 📢 Crear Release con las release notes generadas
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.new_tag }}
          release_name: Release ${{ env.new_tag }}
          body: |
            ## 🚀 Changes in this release
            
            ### 🔥 Pull Requests Merged
            ${{ env.pr_list }}

            ### 📌 Commits
            ${{ env.commit_list }}

          draft: false
          prerelease: false
