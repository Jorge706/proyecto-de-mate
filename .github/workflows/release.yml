name: Create Release and Compare to Last "real" Release

on:
  workflow_dispatch:

jobs:
  create_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      # ğŸ”¢ Generar un nuevo tag para el release
      - name: Generate new version tag
        id: generate_tag
        run: |
          new_tag="releas-v1.0.0-$(date +%Y%m%d%H%M%S)"
          echo "new_tag=$new_tag" >> $GITHUB_ENV

      # ğŸ“¢ Crear el Release
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.new_tag }}
          release_name: Release ${{ env.new_tag }}
          body: "Auto-generated release"
          draft: false
          prerelease: false

      # ğŸ” Obtener el Ãºltimo release cuyo NOMBRE comience con "real"
      - name: Get last release starting with "real"
        id: get_last_real_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          last_real_release=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases" | \
            jq -r '[.[] | select(.name | test("^real"))] | sort_by(.published_at) | last')

          last_real_tag=$(echo "$last_real_release" | jq -r '.tag_name')

          if [[ -z "$last_real_tag" || "$last_real_tag" == "null" ]]; then
            echo "No previous 'real' release found. Skipping compare."
            exit 0
          fi

          echo "last_real_tag=$last_real_tag" >> $GITHUB_ENV

      # ğŸ” Hacer el compare entre el nuevo release y el Ãºltimo "real"
      - name: Compare changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Comparing ${{ env.last_real_tag }} with ${{ env.new_tag }}..."
          compare_url="https://github.com/${{ github.repository }}/compare/${{ env.last_real_tag }}...${{ env.new_tag }}"
          echo "ğŸ”— View the compare results: $compare_url"
